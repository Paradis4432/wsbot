<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">

    <style>
        .image-container {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .image-container img {
            width: 33.33%;
            max-height: 180px;
            object-fit: contain;
        }

        .text-container {
            clear: both;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>

</head>

<body style="background-color: grey;">
    <h2>negocio {{ neg }}</h2>
    <button><a href="/">home</a></button>
    <button><a href="/images/{{neg}}/{{t}}">atras</a></button>
    <button><a href="/images/{{neg}}/{{t}}/" group={{group}} onclick="goNext()">anterior</a></button>
    <button><a href="/images/{{neg}}/{{t}}/" group={{group}} onclick="goNext()">siguiente</a></button>


    <div class="container-fluid">
        <div class="image-container">
            {% for src in srcs["images"] %}
            <img data-enlargable src="../../../static/{{src}}" alt="img" onclick="changeImgSize(this)">
            <!-- idea use bootstrap viewports to auto change size  -->
            {% endfor %}
        </div>

        <div class="text-container">
            {% for data in srcs %}
            {% if data == 'images' %}
            <button onclick="$('#imgControl').toggle()">imagen control</button>
            <div class="row" id="imgControl">
                <div class="col">
                    {% for img in srcs[data] %}
                    <div style="display: flex; align-items: center;">
                        <p style="color: white">{{img}}</p>
                        <button neg={{neg}} t={{t}} group={{group}} imgName={{img}}
                            onclick="delImg(this)">eliminar</button>
                    </div>

                    {% endfor %}

                    <input type="file" name="newImage" id="newImage">
                    <input type="checkbox" name="newImageKO"> mantener original
                    <input type="checkbox" name="newImageARR"> agregar flechas
                    <br>
                    <br>
                    <button neg={{neg}} t={{t}} group={{group}} onclick="saveImg(this)">guardar imagen</button>
                </div>

            </div>
            {% else %}
            {% if data == 'uniqueID' %}
            <div class="row">
                <div class="col">
                    <p style="color: white">{{data}} : {{srcs[data]}}</p>
                </div>

            </div>
            {% else %}
            <div class="row">
                <div class="col-4">
                    <p style="color: white">{{data}}</p>
                </div>
                <div class="col">
                    <input type="text" id="{{data}}" placeholder="{{srcs[data]}}" class="dataInput">
                </div>
                {% if data == 'descripcion' %}
                <p style="color: white;">{{srcs[data]}}</p>
                {% endif %}
            </div>
            {% endif %}
            {% endif %}

            {% endfor %}
            <button neg={{neg}} t={{t}} group={{group}} onclick="updateValues(this)">actualizar</button>
        </div>

        <p>key - value: key va a ser la palabra que se usa para representar el value, por ejemplo dado "altura: 10 cm"
            altura es el key y 10cm es el value</p>
        <p>al agregar un nuevo valor se refresca la pagina</p>
        <input type="text" id="key" placeholder="key">
        <input type="text" id="value" placeholder="value">
        <button neg={{neg}} t={{t}} group={{group}} onclick="addValue(this)">agregar</button>
    </div>




    <script>
        function saveImg(el) {

            console.log($("#newImage")[0].files[0]);
            const formData = new FormData();
            formData.append("neg", el.getAttribute("neg"));
            formData.append("t", el.getAttribute("t"));
            formData.append("group", el.getAttribute("group"));
            formData.append("KO", $("input[name=newImageKO]").is(":checked"));
            formData.append("ARR", $("input[name=newImageARR]").is(":checked"));
            formData.append("image", $("#newImage")[0].files[0]);

            fetch("/saveImg", {
                method: "POST",
                body: formData
            })
                .then(response => response.json())
                .then(response => alert(response["info"]))
                .catch(error => console.error(error));

        }

        function delImg(el) {
            const updateData = {
                neg: el.getAttribute("neg"),
                t: el.getAttribute("t"),
                group: el.getAttribute("group"),
                imgName: el.getAttribute("imgName")
            };

            fetch("/delImg", {
                method: "POST",
                body: JSON.stringify(updateData),
                headers: { "Content-Type": "application/json" },
            })
                .then(response => response.json())
                .then(response => alert(response["info"]))
                .catch(error => console.error(error));
        }


        first = true

        function changeImgSize(el) {
            if (!first) return;

            var src = $(el).attr('src');
            var div = $('<div>').css({
                background: 'RGBA(0,0,0,.5) url(' + src + ') no-repeat center',
                backgroundSize: 'contain',
                width: '100%',
                height: '100%',
                position: 'fixed',
                zIndex: '10000',
                top: '0',
                left: '0',
                cursor: 'zoom-out'
            }).click(function () {
                $(this).remove();
            });

            $('body').append(div);
            first = false;
        }

        $('img[data-enlargable]').addClass('img-enlargable').click(function () {
            changeImgSize(this);
            first = true;
        });

        function addValue(el) {
            const updateData = {
                key: $("#key").val(),
                value: $("#value").val(),
                neg: el.getAttribute("neg"),
                t: el.getAttribute("t"),
                group: el.getAttribute("group")
            };
            if (updateData.key.trim() === "" || updateData.value.trim() === "") {
                alert("es necesario escribrir algo tanto el key como el value");
                return;
            }

            fetch("/addValue", {
                method: "POST",
                body: JSON.stringify(updateData),
                headers: { "Content-Type": "application/json" },
            })
                .then(response => response.json())
                .then(response => { alert(response["info"]); location.reload() })
                .catch(error => console.error(error));
        }

        function updateValues(el) {
            const updateData = {
                neg: el.getAttribute("neg"),
                t: el.getAttribute("t"),
                group: el.getAttribute("group")
            };
            $('input.dataInput').each(function () {
                const id = $(this).prop('id');
                const value = $(this).prop('value');
                const placeholder = $(this).prop('placeholder');

                if (value && value !== placeholder) {
                    updateData[id] = value;
                }
            });

            if (Object.keys(updateData).length > 3) {
                fetch("/updateValues", {
                    method: "POST",
                    body: JSON.stringify(updateData),
                    headers: { "Content-Type": "application/json" },
                })
                    .then(response => response.json())
                    .then(response => alert(response["info"]))
                    .catch(error => console.error(error));
            } else {
                alert("no se encontraron valores para actualizar ")
            }
        }

        function goNext() {
            // get request to check if next exists, if true add 1 to this.group, else alert "no existe"
        }
    </script>

</body>

</html>